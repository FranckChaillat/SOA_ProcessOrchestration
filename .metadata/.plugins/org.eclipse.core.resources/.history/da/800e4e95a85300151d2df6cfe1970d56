package serviceContractCheckEngine

import java.util.TimerTask
import serviceConsumer.serviceInventory.InventoryManager
import serviceConsumer.ServiceProvider
import scala.collection.mutable.ListBuffer
import processOrchestration.Silos
import scala.xml.XML


/**
 * @author fra
 */
object Watcher {
    new Thread(new Runnable{def run= discover}).start
  
   def discover(){
     new java.util.Timer().scheduleAtFixedRate(new TimerTask{ 
       
       def run(){
         
         def discover(silos : List[Silos])   = {
            if (silos.length>0){
              val props = InventoryManager.getDiscoveryProps(silos(0).name)
              val res = new ServiceProvider().execute(Map("host" -> props("host"),
                                                "silosUri"-> props("baseUri"),
                                                "uri" -> props("uri"),
                                                "httpMethod" -> "GET",
                                                "dataType"-> "application/xml"), Map())
             
              checkUpdates(res, silos(0))
              
            }
         }
         
         System.out.print("check inventory...")
         val res = InventoryManager.getSilos

         discover(res)
         
       }}, 0, 1000*60 *5)
   }
    
    
    def checkUpdates(wadlContent: String, silos: Silos){
      
     
      val xml= XML.loadString(wadlContent)
      val s=InventoryManager.getService().map((f)=>{f("uri")}).toList
      val aa = xml.\\("resources")(0).child.map { x => x.\("@path") text }
      
      val missing = aa.filterNot { x => s.contains(x) }
      missing.foreach { x => Map("uri" -> x,
                                 "serviceName" -> x.substring(1),
                                 "host" -> xml.\\("resources").\@("base").split("/")(2).split(":")(0),
                                 "silosId" -> silos.id)}
      
      //println(aa.foreach { x => print(x)
        //                   print(s.contains(x)) })
      
    
    
      
    
    }
    
}